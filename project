import os
import pygame
import math

from textures import Texture_Back, load_map, load_level, textures_spr, blocks, coins, COUNT_COIN
from activities import Player, Snowball, players, snowballs1, snowballs2

pygame.init()

size = width, height = 500, 500
screen = pygame.display.set_mode(size)

JUMP_POWER = 11
MOVE_SPEED = 4
GRAVITY = 1


def load_image(name, colorkey=None):
    fullname = os.path.join('data', name)
    try:
        image = pygame.image.load(fullname)
    except pygame.error as message:
        print('Cannot load image:', name)
        raise SystemExit(message)
    image = image.convert_alpha()

    if colorkey is not None:
        if colorkey is -1:
            colorkey = image.get_at((0, 0))
        image.set_colorkey(colorkey)
    return image

def load_endgame():
    font = pygame.font.Font(None, 50)
    text = font.render("you win", 1, (100, 255, 100))
    text_x = width // 2 - text.get_width() // 2
    text_y = height // 2 - text.get_height() // 2
    text_w = text.get_width()
    text_h = text.get_height()
    screen.blit(text, (text_x, text_y))
    pygame.draw.rect(screen, (0, 255, 0), (text_x - 10, text_y - 10,
                                           text_w + 20, text_h + 20), 1)     
            
load_map(load_level('level'))

clock = pygame.time.Clock()

team_1, team_2 = pygame.sprite.Group(), pygame.sprite.Group()
player1 = Player((30, 465))
player1.add(team_1)

player2 = Player((30, 30))
player2.add(team_2)

running_screen = True
left1 = False
right1 = False
up1 = False

left2 = False
right2 = False
up2 = False


while running_screen:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running_screen = False
        
        if event.type == pygame.KEYDOWN:
            
            if event.key == pygame.K_UP:
                up2 = True

            if event.key == pygame.K_LEFT:
                left2 = True
                    
            if event.key == pygame.K_RIGHT:
                right2 = True
            
            if event.key == pygame.K_w:
                up1 = True
        
            if event.key == pygame.K_a:
                left1 = True
        
            if event.key == pygame.K_d:
                right1 = True                
                
        if event.type == pygame.KEYUP:
            
            if event.key == pygame.K_UP:
                up2 = False
        
            if event.key == pygame.K_LEFT:
                left2 = False
        
            if event.key == pygame.K_RIGHT:
                right2 = False
                
            if event.key == pygame.K_w:
                up1 = False
        
            if event.key == pygame.K_a:
                left1 = False
        
            if event.key == pygame.K_d:
                right1 = False              
            if event.key == pygame.K_e:
                Snowball((player1.rect.x, player1.rect.y), 1, 1)
                
            if event.key == pygame.K_q:
                Snowball((player1.rect.x, player1.rect.y), -1, 1)
                
            if event.key == pygame.K_m:
                Snowball((player2.rect.x, player2.rect.y), 1, 2)
                
            if event.key == pygame.K_n:
                Snowball((player2.rect.x, player2.rect.y), -1, 2)
                       
    screen.fill((0, 0, 0))
    if player1.count == COUNT_COIN:
        load_endgame() 
    else:
        if pygame.sprite.spritecollideany(player1, coins):
            candidate = pygame.sprite.spritecollide(player1, coins, False)
            player1.count += 1
            chg = Texture_Back((candidate[0].rect.x, candidate[0].rect.y))
            candidate = pygame.sprite.spritecollide(player1, coins, True)
            
        player1.update(left1, right1, up1, blocks)
        player2.update(left2, right2, up2, blocks)
        
        for snowball in snowballs1:
            snowball.hurt(team_2)
            snowball.update(blocks)
            
        for snowball in snowballs2:
            snowball.hurt(team_1)
            snowball.update(blocks)
            
            
        textures_spr.draw(screen)
        players.draw(screen)
        snowballs1.draw(screen)
        snowballs2.draw(screen)
        
    clock.tick(60)
    pygame.display.flip()
    
pygame.quit()
